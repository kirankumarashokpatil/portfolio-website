name: Update Portfolio Stats

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:      # Manual trigger
  
env:
  GITHUB_USERNAME: 'your-github-username'  # Replace with your GitHub username

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Create update script
        run: |
          cat > update-stats.js << 'EOF'
          const fs = require('fs');
          const https = require('https');
          
          function fetchData(url) {
            return new Promise((resolve, reject) => {
              https.get(url, {
                headers: {
                  'User-Agent': 'portfolio-updater',
                  'Authorization': process.env.GITHUB_TOKEN ? `token ${process.env.GITHUB_TOKEN}` : ''
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch (e) {
                    reject(e);
                  }
                });
              }).on('error', reject);
            });
          }
          
          async function updateStats() {
            try {
              console.log('üîÑ Fetching GitHub stats...');
              
              // Fetch user data
              const userData = await fetchData(`https://api.github.com/users/${process.env.GITHUB_USERNAME}`);
              
              // Fetch repositories
              const reposData = await fetchData(`https://api.github.com/users/${process.env.GITHUB_USERNAME}/repos?sort=updated&per_page=10`);
              
              // Calculate stats
              const stats = {
                followers: userData.followers,
                following: userData.following,
                public_repos: userData.public_repos,
                total_stars: reposData.reduce((sum, repo) => sum + repo.stargazers_count, 0),
                last_updated: new Date().toISOString(),
                featured_repos: reposData
                  .filter(repo => repo.stargazers_count > 0 || repo.fork === false)
                  .slice(0, 6)
                  .map(repo => ({
                    name: repo.name,
                    description: repo.description,
                    stars: repo.stargazers_count,
                    forks: repo.forks_count,
                    language: repo.language,
                    url: repo.html_url,
                    updated_at: repo.updated_at
                  }))
              };
              
              // Ensure data directory exists
              if (!fs.existsSync('public/data')) {
                fs.mkdirSync('public/data', { recursive: true });
              }
              
              // Write stats
              fs.writeFileSync('public/data/github-stats.json', JSON.stringify(stats, null, 2));
              
              console.log('‚úÖ GitHub stats updated successfully!');
              console.log(`üìä Stats: ${stats.public_repos} repos, ${stats.total_stars} stars, ${stats.followers} followers`);
              
            } catch (error) {
              console.error('‚ùå Error updating stats:', error.message);
              process.exit(1);
            }
          }
          
          updateStats();
          EOF
          
      - name: Update GitHub stats
        run: node update-stats.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ env.GITHUB_USERNAME }}
          
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/data/github-stats.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ü§ñ Auto-update: GitHub stats $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
          fi